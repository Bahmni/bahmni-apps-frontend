name: Publish Packages

on:
  push:
    branches: [workflows]
    paths:
      - 'packages/**'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  # Detect which packages are affected by the changes
  detect-affected:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build affected projects with dependencies
        run: |
          # Build all affected projects including their dependencies
          # This ensures all packages are built in correct dependency order
          echo "Building affected projects and their dependencies..."
          npx nx affected --target=build --with-deps --base=${{ github.event.before }} || echo "No affected projects to build"

      - name: Test affected projects
        run: |
          # Test all affected projects
          echo "Testing affected projects..."
          npx nx affected --target=test --base=${{ github.event.before }} || echo "No affected projects to test"

      - name: Detect affected packages and apps for publishing
        id: set-matrix
        run: |
          # Get all affected projects (packages and apps)
          AFFECTED_RAW=$(npx nx show projects --affected --base=${{ github.event.before }} 2>/dev/null || echo "")
          
          echo "Affected projects: $AFFECTED_RAW"
          
          # Define our publishable packages and apps with their paths
          declare -A PUBLISHABLE_PROJECTS=(
            ["@bahmni/services"]="packages/bahmni-services"
            ["@bahmni/design-system"]="packages/bahmni-design-system"
            ["@bahmni/widgets"]="packages/bahmni-widgets"
            ["@bahmni/clinical-app"]="apps/clinical"
            ["@bahmni/registration-app"]="apps/registration"
          )
          
          # Build matrix JSON by checking which publishable projects are affected
          MATRIX_JSON="[]"
          
          # Process in dependency order
          for PROJECT_NAME in "@bahmni/services" "@bahmni/design-system" "@bahmni/widgets" "@bahmni/clinical-app" "@bahmni/registration-app"; do
            if echo "$AFFECTED_RAW" | grep -q "$PROJECT_NAME"; then
              PROJECT_PATH="${PUBLISHABLE_PROJECTS[$PROJECT_NAME]}"
              echo "Adding $PROJECT_NAME to publish matrix"
              MATRIX_JSON=$(echo "$MATRIX_JSON" | jq --arg name "$PROJECT_NAME" --arg path "$PROJECT_PATH" '. + [{"name": $name, "path": $path}]')
            fi
          done
          
          # For workflow_dispatch, include all packages and apps if none detected
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$(echo $MATRIX_JSON | jq '. | length')" -eq 0 ]; then
            echo "Workflow dispatch with no affected projects - publishing all"
            MATRIX_JSON='[{"name": "@bahmni/services", "path": "packages/bahmni-services"}, {"name": "@bahmni/design-system", "path": "packages/bahmni-design-system"}, {"name": "@bahmni/widgets", "path": "packages/bahmni-widgets"}, {"name": "@bahmni/clinical-app", "path": "apps/clinical"}, {"name": "@bahmni/registration-app", "path": "apps/registration"}]'
          fi
          
          # Create final matrix with compact JSON output
          MATRIX=$(echo "{\"include\":$MATRIX_JSON}" | jq -c .)
          
          echo "Publish Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Publish packages using matrix strategy
  publish-packages:
    needs: detect-affected
    if: needs.detect-affected.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    environment: npm-publish
    strategy:
      matrix: ${{ fromJson(needs.detect-affected.outputs.matrix) }}
      max-parallel: 1  # Publish one package at a time to maintain dependency order
      fail-fast: false
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint ${{ matrix.name }}
        run: npx nx lint ${{ matrix.name }}

      - name: Build ${{ matrix.name }} with dependencies for publishing
        run: npx nx build ${{ matrix.name }} --with-deps

      - name: Publish dev build to npm
        working-directory: ${{ matrix.path }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing ${{ matrix.name }}@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          #npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published ${{ matrix.name }}@$DEV_VERSION"
          echo "::notice title=Install Command::npm install ${{ matrix.name }}@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"
