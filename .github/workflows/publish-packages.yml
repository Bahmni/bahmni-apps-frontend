name: Publish Packages

on:
  push:
    branches: [workflows]
    paths:
      - 'packages/**'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  # Detect which packages are affected by the changes
  detect-affected:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Detect affected packages, apps and create matrix
        id: set-matrix
        run: |
          # Get affected library projects
          AFFECTED_RAW=$(npx nx show projects --affected --base=${{ github.event.before }} --type=lib 2>/dev/null || echo "")
          
          # Filter to only include our three packages and two apps
          AFFECTED=$(echo "$AFFECTED_RAW" | grep -E "(@bahmni/services|@bahmni/design-system|@bahmni/widgets|@bahmni/clinical-app|@bahmni/registration-app)" || echo "")
          
          # Determine which packages to publish (affected + all dependents)
          PUBLISH_SERVICES=false
          PUBLISH_DESIGN_SYSTEM=false
          PUBLISH_WIDGETS=false
          PUBLISH_CLINICAL_APP=false
          PUBLISH_REGISTRATION_APP=false
          
          # If services is affected, publish all packages (everything depends on it) and apps
          if echo "$AFFECTED" | grep -q "@bahmni/services"; then
            PUBLISH_SERVICES=true
            PUBLISH_DESIGN_SYSTEM=true
            PUBLISH_WIDGETS=true
            PUBLISH_CLINICAL_APP=true
            PUBLISH_REGISTRATION_APP=true
            echo "Services affected - will publish all packages and apps"
          fi
          
          # If design-system is affected, publish design-system and widgets (widgets depends on it) and apps
          if echo "$AFFECTED" | grep -q "@bahmni/design-system"; then
            PUBLISH_DESIGN_SYSTEM=true
            PUBLISH_WIDGETS=true
            PUBLISH_CLINICAL_APP=true
            PUBLISH_REGISTRATION_APP=true
            echo "Design-system affected - will publish design-system and widgets and apps"
          fi
          
          # If widgets is affected, publish only widgets and apps
          if echo "$AFFECTED" | grep -q "@bahmni/widgets"; then
            PUBLISH_WIDGETS=true
            PUBLISH_CLINICAL_APP=true
            PUBLISH_REGISTRATION_APP=true
            echo "Widgets affected - will publish widgets and apps"
          fi

          # If cinical-app is affected, publish only clinical-app (nothing depends on it)
          if echo "$AFFECTED" | grep -q "@bahmni/clinical-app"; then
            PUBLISH_CLINICAL_APP=true
            echo "Clinical-app affected - will publish clinical-app"
          fi

          # If registration-app is affected, publish only registration-app (nothing depends on it)
          if echo "$AFFECTED" | grep -q "@bahmni/registration-app"; then
            PUBLISH_REGISTRATION_APP=true
            echo "Registration-app affected - will publish registration-app"
          fi
          
          # Build matrix JSON in dependency order: services â†’ design-system â†’ widgets
          MATRIX_JSON="[]"
          
          if [ "$PUBLISH_SERVICES" = true ]; then
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq '. + [{"name": "@bahmni/services", "path": "packages/bahmni-services"}]')
          fi
          
          if [ "$PUBLISH_DESIGN_SYSTEM" = true ]; then
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq '. + [{"name": "@bahmni/design-system", "path": "packages/bahmni-design-system"}]')
          fi
          
          if [ "$PUBLISH_WIDGETS" = true ]; then
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq '. + [{"name": "@bahmni/widgets", "path": "packages/bahmni-widgets"}]')
          fi

          if [ "$PUBLISH_CLINICAL_APP" = true ]; then
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq '. + [{"name": "@bahmni/clinical-app", "path": "apps/clinical"}]')
          fi

          if [ "$PUBLISH_REGISTRATION_APP" = true ]; then
            MATRIX_JSON=$(echo "$MATRIX_JSON" | jq '. + [{"name": "@bahmni/registration-app", "path": "apps/registration"}]')
          fi
          
          # For workflow_dispatch, include all packages and apps if none detected
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "$(echo $MATRIX_JSON | jq '. | length')" -eq 0 ]; then
            MATRIX_JSON='[{"name": "@bahmni/services", "path": "packages/bahmni-services"}, {"name": "@bahmni/design-system", "path": "packages/bahmni-design-system"}, {"name": "@bahmni/widgets", "path": "packages/bahmni-widgets"}, {"name": "@bahmni/clinical-app", "path": "apps/clinical"}, {"name": "@bahmni/registration-app", "path": "apps/registration"}]'
          fi
          
          # Create final matrix with compact JSON output
          MATRIX=$(echo "{\"include\":$MATRIX_JSON}" | jq -c .)
          
          echo "Matrix: $MATRIX"
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # Publish packages using matrix strategy
  publish-packages:
    needs: detect-affected
    if: needs.detect-affected.outputs.matrix != '{"include":[]}'
    runs-on: ubuntu-latest
    environment: npm-publish
    strategy:
      matrix: ${{ fromJson(needs.detect-affected.outputs.matrix) }}
      max-parallel: 1  # Publish one package at a time to maintain dependency order
      fail-fast: false
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint ${{ matrix.name }}
        run: npx nx lint ${{ matrix.name }}

      - name: Test ${{ matrix.name }}
        run: npx nx test ${{ matrix.name }}

      - name: Build ${{ matrix.name }}
        run: npx nx build ${{ matrix.name }}

      - name: Publish dev build to npm
        working-directory: ${{ matrix.path }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing ${{ matrix.name }}@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          #npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published ${{ matrix.name }}@$DEV_VERSION"
          echo "::notice title=Install Command::npm install ${{ matrix.name }}@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"
