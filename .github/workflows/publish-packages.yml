name: Publish Packages

on:
  push:
    branches: [workflows]
    paths:
      - 'packages/**'
  workflow_dispatch:

env:
  NODE_VERSION: '22'

jobs:
  # Detect which packages are affected by the changes
  detect-affected:
    runs-on: ubuntu-latest
    outputs:
      affected_packages: ${{ steps.affected.outputs.packages }}
      has_services: ${{ steps.check.outputs.has_services }}
      has_design_system: ${{ steps.check.outputs.has_design_system }}
      has_widgets: ${{ steps.check.outputs.has_widgets }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Detect affected packages
        id: affected
        run: |
          # Get affected library projects
          AFFECTED=$(npx nx show projects --affected --base=origin/main --type=lib || echo "")
          
          # If no affected projects detected, check all packages (for manual dispatch or first run)
          if [ -z "$AFFECTED" ]; then
            AFFECTED="@bahmni/services @bahmni/design-system @bahmni/widgets"
          fi
          
          echo "Affected packages: $AFFECTED"
          echo "packages=$AFFECTED" >> $GITHUB_OUTPUT

      - name: Check which packages are affected
        id: check
        run: |
          AFFECTED="${{ steps.affected.outputs.packages }}"
          
          if echo "$AFFECTED" | grep -q "services"; then
            echo "has_services=true" >> $GITHUB_OUTPUT
          else
            echo "has_services=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$AFFECTED" | grep -q "design-system"; then
            echo "has_design_system=true" >> $GITHUB_OUTPUT
          else
            echo "has_design_system=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$AFFECTED" | grep -q "widgets"; then
            echo "has_widgets=true" >> $GITHUB_OUTPUT
          else
            echo "has_widgets=false" >> $GITHUB_OUTPUT
          fi

  # Publish @bahmni/services (no dependencies)
  # Note: PACKAGE_NAME is the scoped npm name, PACKAGE_PATH is the directory path
  publish-services:
    needs: detect-affected
    if: needs.detect-affected.outputs.has_services == 'true'
    runs-on: ubuntu-latest
    environment: npm-publish
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      PACKAGE_NAME: '@bahmni/services'  # Scoped npm package name
      PACKAGE_PATH: 'packages/bahmni-services'  # Directory path (without @bahmni scope)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint
        run: npx nx lint @bahmni/services

      - name: Test
        run: npx nx test @bahmni/services

      - name: Build with dependencies
        run: npx nx build @bahmni/services --with-deps

      - name: Publish dev build to npm
        working-directory: ${{ env.PACKAGE_PATH }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing @bahmni/services@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          #npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published @bahmni/services@$DEV_VERSION"
          echo "::notice title=Install Command::npm install @bahmni/services@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"

  # Publish @bahmni/design-system (depends on services)
  # Note: PACKAGE_NAME is the scoped npm name, PACKAGE_PATH is the directory path
  publish-design-system:
    needs: [detect-affected, publish-services]
    if: |
      always() &&
      needs.detect-affected.outputs.has_design_system == 'true' &&
      (needs.publish-services.result == 'success' || needs.publish-services.result == 'skipped')
    runs-on: ubuntu-latest
    environment: npm-publish
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      PACKAGE_NAME: '@bahmni/design-system'  # Scoped npm package name
      PACKAGE_PATH: 'packages/bahmni-design-system'  # Directory path (without @bahmni scope)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint
        run: npx nx lint @bahmni/design-system

      - name: Test
        run: npx nx test @bahmni/design-system

      - name: Build with dependencies
        run: npx nx build @bahmni/design-system --with-deps

      - name: Publish dev build to npm
        working-directory: ${{ env.PACKAGE_PATH }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing @bahmni/design-system@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          #npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published @bahmni/design-system@$DEV_VERSION"
          echo "::notice title=Install Command::npm install @bahmni/design-system@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"

  # Publish @bahmni/widgets (depends on design-system and services)
  # Note: PACKAGE_NAME is the scoped npm name, PACKAGE_PATH is the directory path
  publish-widgets:
    needs: [detect-affected, publish-services, publish-design-system]
    if: |
      always() &&
      needs.detect-affected.outputs.has_widgets == 'true' &&
      (needs.publish-services.result == 'success' || needs.publish-services.result == 'skipped') &&
      (needs.publish-design-system.result == 'success' || needs.publish-design-system.result == 'skipped')
    runs-on: ubuntu-latest
    environment: npm-publish
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      PACKAGE_NAME: '@bahmni/widgets'  # Scoped npm package name
      PACKAGE_PATH: 'packages/bahmni-widgets'  # Directory path (without @bahmni scope)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Lint
        run: npx nx lint @bahmni/widgets

      - name: Test
        run: npx nx test @bahmni/widgets

      - name: Build with dependencies
        run: npx nx build @bahmni/widgets --with-deps

      - name: Publish dev build to npm
        working-directory: ${{ env.PACKAGE_PATH }}
        run: |
          # Base version from package.json
          BASE_VERSION=$(node -p "require('./package.json').version")
          BUILD_NUM=${{ github.run_number }}

          # Generate unique dev version (e.g., 0.0.1-dev.42)
          DEV_VERSION="${BASE_VERSION}-dev.${BUILD_NUM}"
          echo "ðŸ“¦ Publishing @bahmni/widgets@$DEV_VERSION"

          # Update package version and publish
          npm version "$DEV_VERSION" --no-git-tag-version
          #npm publish --access public --tag dev
          
          # Output information
          echo "::notice title=Package Published::Published @bahmni/widgets@$DEV_VERSION"
          echo "::notice title=Install Command::npm install @bahmni/widgets@dev"
          echo "::notice title=Build Info::Build #${BUILD_NUM}"
